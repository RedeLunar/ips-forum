;(function($,_,undefined){"use strict";ips.controller.register('core.front.widgets.recentTopics',{uniqueId:'',interval:30,showLoading:true,ourTids:{},removalInProgress:false,maxElements:5,rebuildTids:true,recountList:false,initialize:function(){var blockId=$('#recentTopicsWrapper').parent().attr('data-blockid').split('_');this.uniqueId=blockId[blockId.length-1];this.interval=parseInt($('#recentTopicsWrapper').attr('data-recenttopics-interval'));if($('#recentTopicsWrapper').attr('data-recenttopics-showloading')){this.showLoading=!!$.parseJSON($('#recentTopicsWrapper').attr('data-recenttopics-showloading'));}
if(this.interval<15){this.interval=15;}
this.buildOurTids();window.setTimeout(_.bind(this.updateTopics,this,true),this.interval*1000);},updateTopics:function(){var ajaxUrl=ips.getSetting('baseURL')+'index.php?app=core&module=system&section=plugins&do=mdmxRecentTopics';this._setLoading(true);var that=this;var promise;promise=$.when(promise,$.ajax(ajaxUrl,{method:'POST',dataType:'json',showLoading:this.showLoading,data:{uniqueId:this.uniqueId,our_tids:JSON.stringify(this.ourTids)},success:function(res){if(res.updatedTime.length>0){$.each(res.updatedTime,function(k,row){if($('#recentTopics_tid_'+row.tid)){$('#recentTopics_tid_'+row.tid).attr('data-timestamp',row.timestamp);$('#recentTopics_tid_'+row.tid+' .ipsDataItem_lastPoster time').replaceWith(row.date);}});}
if(res.updated.length>0){$.each(res.updated,function(k,row){if($('#recentTopics_tid_'+row.tid)){$('#recentTopics_tid_'+row.tid).remove();}
$('#recentTopicsOuter').prepend(row.html);ips.utils.anim.go('pulseOnce',$('#recentTopics_tid_'+row.tid));});}}}));promise.done(function(){that._setLoading();that.recountTopicListAndDrop();that.buildOurTids();window.setTimeout(_.bind(that.updateTopics,that,true),that.interval*1000);});},recountTopicListAndDrop:function(){if(this.removalInProgress==true){Debug.log("Removal in progress");return false;}
var numElements=$('#recentTopicsOuter > li.ipsDataItem').length;if(numElements>this.maxElements){this.removalInProgress=true;var toRemove=numElements-this.maxElements;for(var tr=0;tr<toRemove;tr++){$('#recentTopicsOuter > li.ipsDataItem').last().remove();}
this.removalInProgress=false;this.buildOurTids();Debug.log("Removed a topic entry");}},buildOurTids:function(){this.ourTids={};var that=this;$('#recentTopicsOuter > li.ipsDataItem').each(function(){var tid=parseInt($(this).attr('data-tid'));var timestamp=parseInt($(this).attr('data-timestamp'));if(tid>0&&timestamp>0){that.ourTids[tid]=[tid,timestamp];}});},_setLoading:function(state){if(this.showLoading){if(state){this.scope.animate({opacity:0.6},'fast');}
else{this.scope.animate({opacity:1},'fast');}}}});}(jQuery,_));;